<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Challenge Trivia Game</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const TriviaGame = () => {
            const categoryMapping = {
                "Geography": 22,
                "Pop Culture": 9,
                "History": 23,
                "Art & Literature": 25,
                "Science": 17,
                "Sports": 21
            };

            const categories = ["Geography", "Pop Culture", "History", "Art & Literature", "Science", "Sports"];

            const [gameStarted, setGameStarted] = useState(false);
            const [numPlayers, setNumPlayers] = useState(2);
            const [playerNames, setPlayerNames] = useState([]);
            const [players, setPlayers] = useState([]);
            const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
            const [currentCategory, setCurrentCategory] = useState("");
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [showResult, setShowResult] = useState(false);
            const [gameOver, setGameOver] = useState(false);
            const [roundNumber, setRoundNumber] = useState(0);
            const [tiebreaker, setTiebreaker] = useState(false);
            const [tiebreakerPlayers, setTiebreakerPlayers] = useState([]);
            const [showPlayerSetup, setShowPlayerSetup] = useState(false);
            const [loading, setLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState("");
            const [questionCache, setQuestionCache] = useState({});

            // Sleep function to add delays
            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const decodeHTML = (html) => {
                const txt = document.createElement('textarea');
                txt.innerHTML = html;
                return txt.value;
            };

            const fetchQuestions = async (category, amount = 20) => {
                try {
                    const categoryId = categoryMapping[category];
                    const response = await fetch(`https://opentdb.com/api.php?amount=${amount}&category=${categoryId}&type=multiple`);
                    const data = await response.json();
                    
                    if (data.response_code === 0) {
                        const formattedQuestions = data.results.map(q => {
                            const incorrectAnswers = q.incorrect_answers.map(a => decodeHTML(a));
                            const correctAnswer = decodeHTML(q.correct_answer);
                            const allAnswers = [...incorrectAnswers, correctAnswer].sort(() => Math.random() - 0.5);
                            
                            return {
                                question: decodeHTML(q.question),
                                answers: allAnswers,
                                correct: allAnswers.indexOf(correctAnswer)
                            };
                        });
                        return formattedQuestions;
                    } else {
                        console.error('API error:', data.response_code);
                        return [];
                    }
                } catch (error) {
                    console.error('Error fetching questions:', error);
                    return [];
                }
            };

            const fetchTiebreakerQuestion = async () => {
                try {
                    const response = await fetch('https://opentdb.com/api.php?amount=1&difficulty=hard&type=multiple');
                    const data = await response.json();
                    
                    if (data.response_code === 0 && data.results.length > 0) {
                        const q = data.results[0];
                        const incorrectAnswers = q.incorrect_answers.map(a => decodeHTML(a));
                        const correctAnswer = decodeHTML(q.correct_answer);
                        const allAnswers = [...incorrectAnswers, correctAnswer].sort(() => Math.random() - 0.5);
                        
                        return {
                            question: decodeHTML(q.question),
                            answers: allAnswers,
                            correct: allAnswers.indexOf(correctAnswer),
                            category: "Tiebreaker"
                        };
                    }
                } catch (error) {
                    console.error('Error fetching tiebreaker:', error);
                }
                return null;
            };

            const startGame = () => {
                setPlayerNames(Array(numPlayers).fill(''));
                setShowPlayerSetup(true);
            };

            const getRandomCategory = () => {
                const randomIndex = Math.floor(Math.random() * categories.length);
                return categories[randomIndex];
            };

            const getRandomQuestion = (category) => {
                const questions = questionCache[category];
                if (!questions || questions.length === 0) return null;
                
                const randomIndex = Math.floor(Math.random() * questions.length);
                return questions[randomIndex];
            };

            const handlePlayerNamesSubmit = async (names) => {
                setLoading(true);
                
                const initialPlayers = names.map(name => ({
                    name: name,
                    completedCategories: [],
                    finishedRound: null,
                }));
                
                setPlayers(initialPlayers);
                
                // Fetch questions for all categories with delays to respect rate limits
                const cache = {};
                for (let i = 0; i < categories.length; i++) {
                    const cat = categories[i];
                    setLoadingMessage(`Loading ${cat} questions... (${i + 1}/${categories.length})`);
                    const questions = await fetchQuestions(cat, 20);
                    cache[cat] = questions;
                    
                    // Wait 5 seconds between API calls (API rate limit requirement)
                    if (i < categories.length - 1) {
                        await sleep(5000);
                    }
                }
                
                setQuestionCache(cache);
                setCurrentPlayerIndex(0);
                
                // Pick random category and question
                const randomCat = getRandomCategory();
                setCurrentCategory(randomCat);
                
                if (cache[randomCat] && cache[randomCat].length > 0) {
                    const randomQ = cache[randomCat][Math.floor(Math.random() * cache[randomCat].length)];
                    setCurrentQuestion(randomQ);
                }
                
                setGameStarted(true);
                setShowPlayerSetup(false);
                setLoading(false);
                setLoadingMessage("");
            };

            const handleAnswerClick = (answerIndex) => {
                if (showResult) return;
                setSelectedAnswer(answerIndex);
                setShowResult(true);
            };

            const handleNextQuestion = async () => {
                const currentPlayer = players[currentPlayerIndex];
                const isCorrect = selectedAnswer === currentQuestion.correct;
                
                if (isCorrect) {
                    const updatedPlayers = [...players];
                    if (!updatedPlayers[currentPlayerIndex].completedCategories.includes(currentCategory)) {
                        updatedPlayers[currentPlayerIndex].completedCategories.push(currentCategory);
                    }
                    
                    if (updatedPlayers[currentPlayerIndex].completedCategories.length === 6) {
                        updatedPlayers[currentPlayerIndex].finishedRound = roundNumber;
                        setPlayers(updatedPlayers);
                        await checkForWinner(updatedPlayers);
                        return;
                    }
                    
                    setPlayers(updatedPlayers);
                    
                    const randomCat = getRandomCategory();
                    setCurrentCategory(randomCat);
                    const nextQuestion = getRandomQuestion(randomCat);
                    setCurrentQuestion(nextQuestion);
                    setSelectedAnswer(null);
                    setShowResult(false);
                } else {
                    await moveToNextPlayer();
                }
            };

            const moveToNextPlayer = async () => {
                const nextPlayerIndex = (currentPlayerIndex + 1) % players.length;
                
                if (nextPlayerIndex === 0) {
                    setRoundNumber(roundNumber + 1);
                }
                
                let actualNextIndex = nextPlayerIndex;
                let checkedPlayers = 0;
                while (players[actualNextIndex].completedCategories.length === 6 && checkedPlayers < players.length) {
                    actualNextIndex = (actualNextIndex + 1) % players.length;
                    checkedPlayers++;
                }
                
                if (checkedPlayers === players.length) {
                    setGameOver(true);
                    return;
                }
                
                setCurrentPlayerIndex(actualNextIndex);
                
                const randomCat = getRandomCategory();
                setCurrentCategory(randomCat);
                const nextQuestion = getRandomQuestion(randomCat);
                setCurrentQuestion(nextQuestion);
                setSelectedAnswer(null);
                setShowResult(false);
            };

            const checkForWinner = async (updatedPlayers) => {
                const finishersThisRound = updatedPlayers.filter(p => p.finishedRound === roundNumber);
                
                if (finishersThisRound.length > 1) {
                    setLoading(true);
                    setLoadingMessage("Loading tiebreaker question...");
                    const tiebreakerQ = await fetchTiebreakerQuestion();
                    setTiebreaker(true);
                    setTiebreakerPlayers(finishersThisRound);
                    setCurrentPlayerIndex(0);
                    setCurrentQuestion(tiebreakerQ);
                    setCurrentCategory("Tiebreaker");
                    setSelectedAnswer(null);
                    setShowResult(false);
                    setLoading(false);
                    setLoadingMessage("");
                } else {
                    const allFinishers = updatedPlayers.filter(p => p.finishedRound !== null);
                    if (allFinishers.length > 0) {
                        setGameOver(true);
                    } else {
                        await moveToNextPlayer();
                    }
                }
            };

            const handleTiebreakerNext = () => {
                if (selectedAnswer === currentQuestion.correct) {
                    setGameOver(true);
                } else {
                    const nextIndex = currentPlayerIndex + 1;
                    if (nextIndex < tiebreakerPlayers.length) {
                        setCurrentPlayerIndex(nextIndex);
                        setSelectedAnswer(null);
                        setShowResult(false);
                    } else {
                        setGameOver(true);
                    }
                }
            };

            const resetGame = () => {
                setGameStarted(false);
                setPlayers([]);
                setPlayerNames([]);
                setCurrentPlayerIndex(0);
                setCurrentCategory("");
                setCurrentQuestion(null);
                setSelectedAnswer(null);
                setShowResult(false);
                setGameOver(false);
                setQuestionCache({});
                setRoundNumber(0);
                setTiebreaker(false);
                setTiebreakerPlayers([]);
                setShowPlayerSetup(false);
            };

            const handlePlayerNameChange = (index, value) => {
                const newNames = [...playerNames];
                newNames[index] = value;
                setPlayerNames(newNames);
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full text-center">
                            <div className="text-6xl mb-4 animate-bounce">üé≤</div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Loading Questions...</h2>
                            <p className="text-gray-600">{loadingMessage || "Fetching fresh trivia from the internet!"}</p>
                            <p className="text-sm text-gray-500 mt-4">This may take up to 30 seconds due to API rate limits</p>
                        </div>
                    </div>
                );
            }

            if (!gameStarted && !showPlayerSetup) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">üë•</div>
                                <h1 className="text-4xl font-bold text-gray-800 mb-2">Category Challenge</h1>
                                <p className="text-gray-600">How many players?</p>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4 mb-8">
                                {[2, 3, 4].map(num => (
                                    <button
                                        key={num}
                                        onClick={() => setNumPlayers(num)}
                                        className={`p-6 rounded-lg font-bold text-2xl transition-all border-4 ${
                                            numPlayers === num
                                                ? 'bg-purple-600 text-white border-purple-700'
                                                : 'bg-white text-gray-800 border-gray-300 hover:border-purple-400'
                                        }`}
                                    >
                                        {num} Players
                                    </button>
                                ))}
                            </div>

                            <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-6">
                                <h3 className="font-bold text-purple-900 mb-2">How to Play:</h3>
                                <ul className="text-sm text-purple-800 space-y-1">
                                    <li>‚Ä¢ Get ONE correct answer in each of 6 categories to win</li>
                                    <li>‚Ä¢ Categories are RANDOM - adds an element of luck!</li>
                                    <li>‚Ä¢ Correct answer = keep going, wrong answer = next player's turn</li>
                                    <li>‚Ä¢ Questions fetched live from the internet - always fresh!</li>
                                    <li>‚Ä¢ If multiple players finish on the same round, there's a tiebreaker!</li>
                                </ul>
                            </div>
                            
                            <button
                                onClick={startGame}
                                className="w-full bg-purple-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-purple-700 transition-colors"
                            >
                                Continue
                            </button>
                        </div>
                    </div>
                );
            }

            if (showPlayerSetup) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full">
                            <div className="text-center mb-8">
                                <h2 className="text-3xl font-bold text-gray-800 mb-2">Enter Player Names</h2>
                                <p className="text-gray-600">All players required</p>
                            </div>
                            
                            <div className="space-y-4 mb-8">
                                {playerNames.map((name, index) => (
                                    <div key={index}>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Player {index + 1} <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            value={name}
                                            onChange={(e) => handlePlayerNameChange(index, e.target.value)}
                                            placeholder={`Enter name for Player ${index + 1}`}
                                            className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                        />
                                    </div>
                                ))}
                            </div>
                            
                            <button
                                onClick={() => {
                                    if (playerNames.every(name => name.trim() !== '')) {
                                        handlePlayerNamesSubmit(playerNames);
                                    } else {
                                        alert('Please enter all player names!');
                                    }
                                }}
                                className="w-full bg-purple-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-purple-700 transition-colors"
                            >
                                Start Game (takes ~30 seconds to load)
                            </button>
                        </div>
                    </div>
                );
            }

            if (gameOver) {
                let winner;
                if (tiebreaker && selectedAnswer === currentQuestion.correct) {
                    winner = tiebreakerPlayers[currentPlayerIndex];
                } else {
                    const finishers = players.filter(p => p.finishedRound !== null).sort((a, b) => a.finishedRound - b.finishedRound);
                    winner = finishers[0];
                }

                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">üèÜ</div>
                                <h1 className="text-4xl font-bold text-gray-800 mb-2">Winner!</h1>
                                <p className="text-3xl text-purple-600 font-semibold">
                                    {winner.name} wins! üéâ
                                </p>
                                {tiebreaker && <p className="text-sm text-gray-600 mt-2">Won by tiebreaker</p>}
                            </div>

                            <div className="mb-8">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 text-center">Final Results</h2>
                                <div className="space-y-3">
                                    {players.map((player, index) => (
                                        <div
                                            key={index}
                                            className={`p-4 rounded-lg ${
                                                player.name === winner.name
                                                    ? 'bg-gradient-to-r from-yellow-100 to-yellow-200 border-2 border-yellow-400'
                                                    : 'bg-gray-100'
                                            }`}
                                        >
                                            <div className="flex justify-between items-center">
                                                <span className="font-semibold text-lg">{player.name}</span>
                                                <span className="text-sm text-gray-600">
                                                    {player.completedCategories.length}/6 categories
                                                </span>
                                            </div>
                                            <div className="mt-2 flex flex-wrap gap-1">
                                                {categories.map(cat => (
                                                    <span
                                                        key={cat}
                                                        className={`text-xs px-2 py-1 rounded ${
                                                            player.completedCategories.includes(cat)
                                                                ? 'bg-green-200 text-green-800'
                                                                : 'bg-gray-200 text-gray-600'
                                                        }`}
                                                    >
                                                        {cat}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <button
                                onClick={resetGame}
                                className="w-full bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                            >
                                üîÑ Play Again
                            </button>
                        </div>
                    </div>
                );
            }

            if (tiebreaker) {
                const currentTiebreakerPlayer = tiebreakerPlayers[currentPlayerIndex];
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-3xl w-full">
                            <div className="text-center mb-6 bg-yellow-100 border-2 border-yellow-400 rounded-lg p-4">
                                <h1 className="text-3xl font-bold text-yellow-900 mb-2">üèÜ TIEBREAKER! üèÜ</h1>
                                <p className="text-yellow-800">First correct answer wins!</p>
                            </div>

                            <div className="mb-6 p-4 bg-orange-50 rounded-lg border-2 border-orange-200">
                                <p className="text-center text-orange-800 font-semibold text-lg">
                                    {currentTiebreakerPlayer.name}'s Turn
                                </p>
                            </div>

                            <h2 className="text-2xl font-bold text-gray-800 mb-8">
                                {currentQuestion?.question}
                            </h2>

                            <div className="space-y-3 mb-8">
                                {currentQuestion?.answers.map((answer, index) => {
                                    let buttonClass = "w-full p-4 text-left rounded-lg font-semibold transition-all border-2 ";
                                    
                                    if (showResult) {
                                        if (index === currentQuestion.correct) {
                                            buttonClass += "bg-green-100 border-green-500 text-green-800";
                                        } else if (index === selectedAnswer) {
                                            buttonClass += "bg-red-100 border-red-500 text-red-800";
                                        } else {
                                            buttonClass += "bg-gray-100 border-gray-300 text-gray-600";
                                        }
                                    } else {
                                        buttonClass += "bg-white border-gray-300 text-gray-800 hover:bg-orange-50 hover:border-orange-400 cursor-pointer";
                                    }

                                    return (
                                        <button
                                            key={index}
                                            onClick={() => handleAnswerClick(index)}
                                            disabled={showResult}
                                            className={buttonClass}
                                        >
                                            {answer}
                                        </button>
                                    );
                                })}
                            </div>

                            {showResult && (
                                <div className="text-center">
                                    <button
                                        onClick={handleTiebreakerNext}
                                        className="bg-orange-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-orange-700 transition-colors"
                                    >
                                        {selectedAnswer === currentQuestion.correct ? "See Winner" : "Next Player"}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            const currentPlayer = players[currentPlayerIndex];

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-3xl w-full">
                        <div className="mb-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                            {players.map((player, index) => (
                                <div
                                    key={index}
                                    className={`p-3 rounded-lg ${
                                        index === currentPlayerIndex
                                            ? 'bg-purple-600 text-white ring-4 ring-purple-300'
                                            : player.completedCategories.length === 6
                                            ? 'bg-green-600 text-white'
                                            : 'bg-gray-100 text-gray-700'
                                    }`}
                                >
                                    <div className="font-bold text-sm truncate">{player.name}</div>
                                    <div className="text-xl font-bold">{player.completedCategories.length}/6</div>
                                    <div className="text-xs mt-1">
                                        {player.completedCategories.length === 6 ? '‚úì Done' : index === currentPlayerIndex ? '‚ñ∂ Playing' : '‚è≥ Waiting'}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <p className="text-center text-purple-800 font-semibold text-lg">
                                {currentPlayer.name}'s Turn
                            </p>
                        </div>

                        <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                            <div className="flex flex-wrap gap-2">
                                {categories.map(cat => (
                                    <span
                                        key={cat}
                                        className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                            currentPlayer.completedCategories.includes(cat)
                                                ? 'bg-green-200 text-green-800'
                                                : cat === currentCategory
                                                ? 'bg-purple-600 text-white'
                                                : 'bg-gray-200 text-gray-600'
                                        }`}
                                    >
                                        {cat} {currentPlayer.completedCategories.includes(cat) && '‚úì'}
                                    </span>
                                ))}
                            </div>
                        </div>

                        <div className="mb-4">
                            <span className="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full">
                                Current Category: {currentCategory}
                            </span>
                        </div>

                        <h2 className="text-2xl font-bold text-gray-800 mb-8">
                            {currentQuestion?.question}
                        </h2>

                        <div className="space-y-3 mb-8">
                            {currentQuestion?.answers.map((answer, index) => {
                                let buttonClass = "w-full p-4 text-left rounded-lg font-semibold transition-all border-2 ";
                                
                                if (showResult) {
                                    if (index === currentQuestion.correct) {
                                        buttonClass += "bg-green-100 border-green-500 text-green-800";
                                    } else if (index === selectedAnswer) {
                                        buttonClass += "bg-red-100 border-red-500 text-red-800";
                                    } else {
                                        buttonClass += "bg-gray-100 border-gray-300 text-gray-600";
                                    }
                                } else {
                                    buttonClass += "bg-white border-gray-300 text-gray-800 hover:bg-purple-50 hover:border-purple-400 cursor-pointer";
                                }

                                return (
                                    <button
                                        key={index}
                                        onClick={() => handleAnswerClick(index)}
                                        disabled={showResult}
                                        className={buttonClass}
                                    >
                                        {answer}
                                    </button>
                                );
                            })}
                        </div>

                        {showResult && (
                            <div className="text-center">
                                <div className="mb-4">
                                    {selectedAnswer === currentQuestion.correct ? (
                                        <p className="text-green-600 font-bold text-lg">
                                            Correct! {currentPlayer.completedCategories.includes(currentCategory) ? "Keep going!" : `${currentCategory} completed!`}
                                        </p>
                                    ) : (
                                        <p className="text-red-600 font-bold text-lg">Wrong! Next player's turn.</p>
                                    )}
                                </div>
                                <button
                                    onClick={handleNextQuestion}
                                    className="bg-purple-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                                >
                                    Continue
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TriviaGame />);
    </script>
</body>
</html>